<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZACMAN - Survival Zombie Game</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Estilos mejorados */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #0a0a0a;
            color: #f0f0f0;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: #111;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            position: relative;
            z-index: 1001;
        }

        .logo {
            font-family: 'Impact', sans-serif;
            font-size: 2.5rem;
            color: #ff0000;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
            letter-spacing: 2px;
        }

        .game-container {
            display: flex;
            flex: 1;
            position: relative;
        }

        #map {
            flex: 1;
            height: 100%;
            z-index: 1;
        }

        .hud {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ff0000;
            min-width: 200px;
            backdrop-filter: blur(5px);
        }

        .stats {
            margin-bottom: 15px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .health-bar {
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #ff0000, #ff5a00);
            width: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .health-text {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 2px black;
            line-height: 20px;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        button {
            background-color: #ff0000;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        button:hover {
            background-color: #ff3333;
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
        }

        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: #111;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #ff0000;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        .modal h2 {
            color: #ff0000;
            margin-bottom: 20px;
            font-size: 2rem;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.7);
        }

        .modal p {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .score-display {
            font-size: 3rem;
            color: #ff0000;
            margin: 20px 0;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.7);
        }

        .hidden {
            display: none;
        }

        /* Iconos personalizados */
        .player-marker {
            background-color: #ff0000;
            border: 3px solid #ffffff;
            border-radius: 50%;
            width: 30px !important;
            height: 30px !important;
            box-shadow: 0 0 15px #ff0000;
            animation: pulse 2s infinite;
        }

        .zombie-marker {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ðŸ’€</text></svg>') center center;
            background-size: contain;
            width: 24px !important;
            height: 24px !important;
            animation: pulse 1.5s infinite;
        }

        .zombie-marker.inactive {
            opacity: 0.6;
        }

        .item-marker {
            background-color: #ffcc00;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 16px !important;
            height: 16px !important;
            box-shadow: 0 0 10px #ffcc00;
        }

        .powerup-marker {
            background-color: #0066ff;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 18px !important;
            height: 18px !important;
            box-shadow: 0 0 10px #0066ff;
            animation: rotate 3s infinite linear;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .notification {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            border-left: 4px solid #ff0000;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .minimap {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff0000;
            border-radius: 10px;
            z-index: 1000;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        .minimap #minimap-container {
            width: 100%;
            height: 100%;
        }

        .powerup-active {
            color: #0066ff;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 102, 255, 0.7);
        }

        .debug-info {
            position: absolute;
            bottom: 180px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        @media (max-width: 768px) {
            .hud {
                top: 10px;
                left: 10px;
                padding: 10px;
                min-width: 160px;
            }

            .controls {
                bottom: 10px;
                right: 10px;
                flex-direction: column;
            }

            .logo {
                font-size: 2rem;
            }

            .minimap {
                width: 100px;
                height: 100px;
                bottom: 10px;
                left: 10px;
            }

            .debug-info {
                bottom: 120px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">ZACMAN</div>
        </header>

        <div class="game-container">
            <div id="map"></div>

            <div class="hud">
                <div class="stats">
                    <div class="stat">
                        <span>PuntuaciÃ³n:</span>
                        <span id="score">0</span>
                    </div>
                    <div class="stat">
                        <span>Suministros:</span>
                        <span id="supplies">0</span>
                    </div>
                    <div class="stat">
                        <span>Zombies:</span>
                        <span id="zombieCount">0</span>
                    </div>
                    <div class="stat">
                        <span>Nivel:</span>
                        <span id="level">1</span>
                    </div>
                </div>

                <div class="health-bar">
                    <div class="health-fill" id="healthBar"></div>
                    <div class="health-text" id="healthText">100%</div>
                </div>

                <div id="powerupInfo">No hay power-ups activos</div>
            </div>

            <div class="minimap">
                <div id="minimap-container"></div>
            </div>

            <div class="debug-info">
                <div>FPS: <span id="fps">0</span></div>
                <div>Zombies activos: <span id="activeZombies">0</span></div>
            </div>

            <div class="controls">
                <button id="startBtn">Iniciar Juego</button>
                <button id="mockBtn">Modo Mock</button>
                <button id="pauseBtn" class="hidden">Pausar</button>
            </div>

            <div id="notification" class="notification">
                Â¡Encontraste suministros!
            </div>

            <div id="startModal" class="modal">
                <div class="modal-content">
                    <h2>ZACMAN</h2>
                    <p>Â¡Sobrevive en un mundo infestado de zombies! Recolecta suministros, evita a los zombies y utiliza power-ups para aumentar tus posibilidades de supervivencia.</p>
                    <p>Tu ubicaciÃ³n se utilizarÃ¡ para crear el mapa de juego. Â¡Moverse en la vida real te moverÃ¡ en el juego!</p>
                    <div class="controls">
                        <button id="startGameBtn">Comenzar</button>
                        <button id="instructionsBtn">Instrucciones</button>
                    </div>
                </div>
            </div>

            <div id="instructionsModal" class="modal hidden">
                <div class="modal-content">
                    <h2>Instrucciones</h2>
                    <p><strong>Objetivo:</strong> Recolecta suministros y sobrevive el mayor tiempo posible.</p>
                    <p><strong>Controles:</strong></p>
                    <ul style="text-align: left; margin-left: 20px; margin-bottom: 15px;">
                        <li>Moverse fÃ­sicamente (modo real)</li>
                        <li>Teclas WASD/Flechas (modo mock)</li>
                    </ul>
                    <p><strong>Power-ups:</strong></p>
                    <ul style="text-align: left; margin-left: 20px;">
                        <li>Arma: Ralentiza zombies por 15 segundos</li>
                        <li>Velocidad: Aumenta tu velocidad por 15 segundos</li>
                    </ul>
                    <button id="backBtn">Volver</button>
                </div>
            </div>

            <div id="gameOverModal" class="modal hidden">
                <div class="modal-content">
                    <h2>Â¡Game Over!</h2>
                    <p>Los zombies te han atrapado...</p>
                    <div class="score-display" id="finalScore">0</div>
                    <p>Suministros recolectados: <span id="finalSupplies">0</span></p>
                    <p>Nivel alcanzado: <span id="finalLevel">1</span></p>
                    <button id="restartBtn">Reintentar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Clases para las entidades del juego
        class Player {
            constructor(lat, lng) {
                this.lat = lat;
                this.lng = lng;
                this.health = 100;
                this.score = 0;
                this.supplies = 0;
                this.speed = 0.0001;
                this.marker = null;
                this.minimapMarker = null;
            }

            updateHealth(change) {
                this.health += change;
                if (this.health > 100) this.health = 100;
                if (this.health < 0) this.health = 0;
                return this.health;
            }

            updateScore(points) {
                this.score += points;
                return this.score;
            }

            collectSupply() {
                this.supplies += 1;
                return this.supplies;
            }
        }

        class Zombie {
            constructor(lat, lng, speed = 0.00002) {
                this.lat = lat;
                this.lng = lng;
                this.speed = speed;
                this.active = false;
                this.marker = null;
                this.group = null; // Referencia al grupo al que pertenece
            }

            moveTowards(targetLat, targetLng) {
                const latDiff = targetLat - this.lat;
                const lngDiff = targetLng - this.lng;
                const distance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
                
                if (distance > 0) {
                    this.lat += (latDiff / distance) * this.speed;
                    this.lng += (lngDiff / distance) * this.speed;
                }

                if (this.marker) {
                    this.marker.setLatLng([this.lat, this.lng]);
                }
            }
        }

        class Supply {
            constructor(lat, lng) {
                this.lat = lat;
                this.lng = lng;
                this.collected = false;
                this.marker = null;
            }
        }

        class PowerUp {
            constructor(lat, lng, type) {
                this.lat = lat;
                this.lng = lng;
                this.type = type; // 'weapon' or 'speed'
                this.collected = false;
                this.marker = null;
            }
        }

        class ZombieGroup {
            constructor() {
                this.zombies = [];
                this.targetLat = 0;
                this.targetLng = 0;
            }

            addZombie(zombie) {
                this.zombies.push(zombie);
                zombie.group = this;
            }

            setTarget(lat, lng) {
                this.targetLat = lat;
                this.targetLng = lng;
            }

            move() {
                // Mover todos los zombies hacia el objetivo
                this.zombies.forEach(zombie => {
                    zombie.moveTowards(this.targetLat, this.targetLng);
                });
            }
        }

        // Game Manager
        class Game {
            constructor() {
                this.map = null;
                this.minimap = null;
                this.player = null;
                this.zombies = [];
                this.supplies = [];
                this.powerups = [];
                this.zombieGroups = [];
                this.gameActive = false;
                this.mockMode = false;
                this.gamePaused = false;
                this.activePowerup = null;
                this.powerupTimer = null;
                this.gameLevel = 1;
                this.lastTimestamp = 0;
                this.fps = 0;
                this.frameCount = 0;
                this.lastFpsUpdate = 0;
                this.zombieSpawnInterval = null;
                this.supplySpawnInterval = null;
                this.watchId = null;

                this.config = {
                    initialZombies: 5,
                    initialSupplies: 15,
                    initialPowerups: 2,
                    minSupplies: 10,
                    minPowerups: 2,
                    zombieSpawnRate: 10000,
                    supplySpawnRate: 8000,
                    baseZombieSpeed: 0.00002,
                    detectionRadius: 0.005,
                    collisionRadius: 0.0003,
                    collectionRadius: 0.0002,
                    groupFormationRadius: 0.002 // Radio para que los zombies formen grupos
                };

                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('startBtn').addEventListener('click', () => this.startGame());
                document.getElementById('mockBtn').addEventListener('click', () => this.startMockMode());
                document.getElementById('startGameBtn').addEventListener('click', () => this.startGame());
                document.getElementById('instructionsBtn').addEventListener('click', () => this.showInstructions());
                document.getElementById('backBtn').addEventListener('click', () => this.hideInstructions());
                document.getElementById('restartBtn').addEventListener('click', () => this.restartGame());
                document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());
            }

            startGame() {
                this.mockMode = false;
                if (navigator.geolocation) {
                    // Usar watchPosition para actualizaciones continuas
                    this.watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            if (!this.player) {
                                this.initPlayer(position.coords.latitude, position.coords.longitude);
                                this.initMap(position.coords.latitude, position.coords.longitude);
                                document.getElementById('startModal').classList.add('hidden');
                                this.gameActive = true;
                                document.getElementById('pauseBtn').classList.remove('hidden');
                                this.generateGameElements();
                                this.startSpawning();
                                requestAnimationFrame((t) => this.gameLoop(t));
                            } else {
                                this.player.lat = position.coords.latitude;
                                this.player.lng = position.coords.longitude;
                                this.player.marker.setLatLng([this.player.lat, this.player.lng]);
                                this.map.setView([this.player.lat, this.player.lng]);
                            }
                        },
                        (error) => {
                            console.error('Error obteniendo la ubicaciÃ³n:', error);
                            alert('Error obteniendo la ubicaciÃ³n. Usando ubicaciÃ³n por defecto.');
                            this.useDefaultLocation();
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 1000 }
                    );
                } else {
                    alert('GeolocalizaciÃ³n no soportada por tu navegador. Usando ubicaciÃ³n por defecto.');
                    this.useDefaultLocation();
                }
            }

            useDefaultLocation() {
                const defaultLocation = { lat: 40.415363, lng: -3.707398 };
                this.initPlayer(defaultLocation.lat, defaultLocation.lng);
                this.initMap(defaultLocation.lat, defaultLocation.lng);
                document.getElementById('startModal').classList.add('hidden');
                this.gameActive = true;
                document.getElementById('pauseBtn').classList.remove('hidden');
                this.generateGameElements();
                this.startSpawning();
                requestAnimationFrame((t) => this.gameLoop(t));
            }

            startMockMode() {
                this.mockMode = true;
                const defaultLocation = { lat: 40.415363, lng: -3.707398 };
                this.initPlayer(defaultLocation.lat, defaultLocation.lng);
                this.initMap(defaultLocation.lat, defaultLocation.lng);
                document.getElementById('startModal').classList.add('hidden');
                this.gameActive = true;
                document.getElementById('pauseBtn').classList.remove('hidden');
                this.initKeyboardControls();
                this.generateGameElements();
                this.startSpawning();
                requestAnimationFrame((t) => this.gameLoop(t));
            }

            initPlayer(lat, lng) {
                this.player = new Player(lat, lng);
            }

            initMap(lat, lng) {
                // Mapa principal
                this.map = L.map('map').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(this.map);

                // Marcador del jugador
                this.player.marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'player-marker',
                        iconSize: [30, 30]
                    })
                }).addTo(this.map);

                // Minimapa
                this.initMinimap(lat, lng);
            }

            initMinimap(lat, lng) {
                this.minimap = L.map('minimap-container', {
                    zoomControl: false,
                    attributionControl: false,
                    dragging: false,
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    boxZoom: false
                }).setView([lat, lng], 14);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.minimap);
                
                // Marcador del jugador en el minimapa
                this.player.minimapMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'player-marker',
                        iconSize: [15, 15]
                    })
                }).addTo(this.minimap);
            }

            initKeyboardControls() {
                document.addEventListener('keydown', (e) => {
                    if (!this.gameActive || this.gamePaused) return;

                    const moveDistance = this.player.speed;

                    switch(e.key) {
                        case 'w':
                        case 'ArrowUp':
                            this.player.lat += moveDistance;
                            break;
                        case 's':
                        case 'ArrowDown':
                            this.player.lat -= moveDistance;
                            break;
                        case 'a':
                        case 'ArrowLeft':
                            this.player.lng -= moveDistance;
                            break;
                        case 'd':
                        case 'ArrowRight':
                            this.player.lng += moveDistance;
                            break;
                    }

                    this.player.marker.setLatLng([this.player.lat, this.player.lng]);
                    this.map.setView([this.player.lat, this.player.lng]);
                });
            }

            startSpawning() {
                this.zombieSpawnInterval = setInterval(() => {
                    if (this.gameActive && !this.gamePaused) {
                        this.spawnZombie();
                    }
                }, this.config.zombieSpawnRate);

                this.supplySpawnInterval = setInterval(() => {
                    if (this.gameActive && !this.gamePaused) {
                        this.spawnSupply();
                    }
                }, this.config.supplySpawnRate);
            }

            spawnZombie() {
                const angle = Math.random() * Math.PI * 2;
                const distance = 0.01 + Math.random() * 0.01;
                
                const zombie = new Zombie(
                    this.player.lat + Math.cos(angle) * distance,
                    this.player.lng + Math.sin(angle) * distance,
                    this.config.baseZombieSpeed + Math.random() * 0.00001
                );

                zombie.marker = L.marker([zombie.lat, zombie.lng], {
                    icon: L.divIcon({
                        className: 'zombie-marker inactive',
                        iconSize: [24, 24]
                    })
                }).addTo(this.map);

                this.zombies.push(zombie);
                document.getElementById('zombieCount').textContent = this.zombies.length;
            }

            spawnSupply() {
                // Mantener un mÃ­nimo de suministros en el mapa
                const currentSupplies = this.supplies.filter(s => !s.collected).length;
                if (currentSupplies >= this.config.minSupplies) return;

                const angle = Math.random() * Math.PI * 2;
                const distance = 0.005 + Math.random() * 0.01;
                
                const supply = new Supply(
                    this.player.lat + Math.cos(angle) * distance,
                    this.player.lng + Math.sin(angle) * distance
                );

                supply.marker = L.marker([supply.lat, supply.lng], {
                    icon: L.divIcon({
                        className: 'item-marker',
                        iconSize: [16, 16]
                    })
                }).addTo(this.map);

                this.supplies.push(supply);
            }

            spawnPowerUp() {
                // Mantener un mÃ­nimo de power-ups en el mapa
                const currentPowerups = this.powerups.filter(p => !p.collected).length;
                if (currentPowerups >= this.config.minPowerups) return;

                const angle = Math.random() * Math.PI * 2;
                const distance = 0.005 + Math.random() * 0.01;

                const powerup = new PowerUp(
                    this.player.lat + Math.cos(angle) * distance,
                    this.player.lng + Math.sin(angle) * distance,
                    Math.random() > 0.5 ? 'weapon' : 'speed'
                );

                powerup.marker = L.marker([powerup.lat, powerup.lng], {
                    icon: L.divIcon({
                        className: 'powerup-marker',
                        iconSize: [18, 18]
                    })
                }).addTo(this.map);

                this.powerups.push(powerup);
            }

            generateGameElements() {
                // Generar zombies iniciales
                for (let i = 0; i < this.config.initialZombies; i++) {
                    this.spawnZombie();
                }

                // Generar suministros iniciales
                for (let i = 0; i < this.config.initialSupplies; i++) {
                    this.spawnSupply();
                }

                // Generar power-ups iniciales
                for (let i = 0; i < this.config.initialPowerups; i++) {
                    this.spawnPowerUp();
                }
            }

            gameLoop(timestamp) {
                if (!this.gameActive) return;

                this.calculateFPS(timestamp);

                if (!this.gamePaused) {
                    this.moveZombies();
                    this.checkCollisions();
                    this.updateMinimap();
                    this.updateActiveZombiesCount();
                }

                requestAnimationFrame((t) => this.gameLoop(t));
            }

            calculateFPS(timestamp) {
                this.frameCount++;
                
                if (timestamp > this.lastFpsUpdate + 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / (timestamp - this.lastFpsUpdate));
                    document.getElementById('fps').textContent = this.fps;
                    this.frameCount = 0;
                    this.lastFpsUpdate = timestamp;
                }
                
                this.lastTimestamp = timestamp;
            }

            moveZombies() {
                // Primero, actualizar el estado de activaciÃ³n de los zombies
                this.zombies.forEach(zombie => {
                    const distanceToPlayer = this.calculateDistance(
                        { lat: zombie.lat, lng: zombie.lng },
                        { lat: this.player.lat, lng: this.player.lng }
                    );

                    if (distanceToPlayer < this.config.detectionRadius) {
                        if (!zombie.active) {
                            zombie.active = true;
                            zombie.marker._icon.classList.remove('inactive');
                        }
                    } else if (zombie.active) {
                        zombie.active = false;
                        zombie.marker._icon.classList.add('inactive');
                    }
                });

                // Formar grupos de zombies
                this.formZombieGroups();

                // Mover zombies individuales o en grupos
                this.zombieGroups.forEach(group => {
                    group.setTarget(this.player.lat, this.player.lng);
                    group.move();
                });

                // Mover zombies que no estÃ¡n en grupos
                this.zombies.filter(z => !z.group && z.active).forEach(zombie => {
                    zombie.moveTowards(this.player.lat, this.player.lng);
                });
            }

            formZombieGroups() {
                // Limpiar grupos vacÃ­os
                this.zombieGroups = this.zombieGroups.filter(group => group.zombies.length > 0);

                // Asignar zombies a grupos
                this.zombies.forEach(zombie => {
                    if (zombie.active && !zombie.group) {
                        // Buscar un grupo cercano
                        let joinedGroup = false;
                        for (const group of this.zombieGroups) {
                            if (group.zombies.length > 0) {
                                const distanceToGroup = this.calculateDistance(
                                    { lat: zombie.lat, lng: zombie.lng },
                                    { lat: group.zombies[0].lat, lng: group.zombies[0].lng }
                                );

                                if (distanceToGroup < this.config.groupFormationRadius) {
                                    group.addZombie(zombie);
                                    joinedGroup = true;
                                    break;
                                }
                            }
                        }

                        // Si no hay grupo cercano, crear uno nuevo
                        if (!joinedGroup) {
                            const newGroup = new ZombieGroup();
                            newGroup.addZombie(zombie);
                            newGroup.setTarget(this.player.lat, this.player.lng);
                            this.zombieGroups.push(newGroup);
                        }
                    }
                });
            }

            checkCollisions() {
                // ColisiÃ³n con suministros
                this.supplies.forEach(supply => {
                    if (!supply.collected) {
                        const distance = this.calculateDistance(
                            { lat: this.player.lat, lng: this.player.lng },
                            { lat: supply.lat, lng: supply.lng }
                        );

                        if (distance < this.config.collectionRadius) {
                            supply.collected = true;
                            this.map.removeLayer(supply.marker);

                            this.player.updateScore(10);
                            this.player.collectSupply();

                            document.getElementById('score').textContent = this.player.score;
                            document.getElementById('supplies').textContent = this.player.supplies;

                            this.showNotification('Â¡Suministro recolectado! +10 puntos');
                            this.checkLevelUp();

                            // Reponer suministro si es necesario
                            setTimeout(() => this.spawnSupply(), 1000);
                        }
                    }
                });

                // ColisiÃ³n con power-ups
                this.powerups.forEach(powerup => {
                    if (!powerup.collected) {
                        const distance = this.calculateDistance(
                            { lat: this.player.lat, lng: this.player.lng },
                            { lat: powerup.lat, lng: powerup.lng }
                        );

                        if (distance < this.config.collectionRadius) {
                            powerup.collected = true;
                            this.map.removeLayer(powerup.marker);
                            this.activatePowerup(powerup.type);

                            // Reponer power-up si es necesario
                            setTimeout(() => this.spawnPowerUp(), 1000);
                        }
                    }
                });

                // ColisiÃ³n con zombies
                this.zombies.forEach(zombie => {
                    const distance = this.calculateDistance(
                        { lat: this.player.lat, lng: this.player.lng },
                        { lat: zombie.lat, lng: zombie.lng }
                    );

                    if (distance < this.config.collisionRadius) {
                        this.player.updateHealth(-5);
                        document.getElementById('healthBar').style.width = this.player.health + '%';
                        document.getElementById('healthText').textContent = this.player.health + '%';

                        this.showNotification('Â¡Zombie te atacÃ³! -5% salud');

                        if (this.player.health <= 0) {
                            this.gameOver();
                        }
                    }
                });
            }

            checkLevelUp() {
                const newLevel = Math.floor(this.player.supplies / 5) + 1;
                if (newLevel > this.gameLevel) {
                    this.gameLevel = newLevel;
                    document.getElementById('level').textContent = this.gameLevel;
                    
                    // Aumentar dificultad
                    this.zombies.forEach(zombie => {
                        zombie.speed += 0.00001;
                    });
                    
                    this.showNotification(`Â¡Nivel ${this.gameLevel} alcanzado! Los zombies son mÃ¡s rÃ¡pidos.`);
                }
            }

            activatePowerup(type) {
                if (this.activePowerup) {
                    clearTimeout(this.powerupTimer);
                }

                this.activePowerup = type;

                if (type === 'weapon') {
                    document.getElementById('powerupInfo').innerHTML = '<span class="powerup-active">Â¡Arma activada!</span> Zombies mÃ¡s lentos por 15 segundos.';
                    this.showNotification('Â¡Power-up de arma activado!');
                    
                    this.zombies.forEach(zombie => {
                        zombie.speed *= 0.5;
                    });
                } else if (type === 'speed') {
                    document.getElementById('powerupInfo').innerHTML = '<span class="powerup-active">Â¡Velocidad aumentada!</span> Movimiento mÃ¡s rÃ¡pido por 15 segundos.';
                    this.showNotification('Â¡Power-up de velocidad activado!');
                    
                    if (this.mockMode) {
                        this.player.speed *= 1.5;
                    }
                }

                this.powerupTimer = setTimeout(() => {
                    if (type === 'weapon') {
                        this.zombies.forEach(zombie => {
                            zombie.speed *= 2;
                        });
                    } else if (type === 'speed' && this.mockMode) {
                        this.player.speed /= 1.5;
                    }
                    
                    this.activePowerup = null;
                    document.getElementById('powerupInfo').textContent = 'No hay power-ups activos';
                    this.showNotification('Power-up desactivado');
                }, 15000);
            }

            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            calculateDistance(point1, point2) {
                const latDiff = point1.lat - point2.lat;
                const lngDiff = point1.lng - point2.lng;
                return Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
            }

            updateMinimap() {
                if (this.minimap && this.player) {
                    this.minimap.setView([this.player.lat, this.player.lng], 14);
                    this.player.minimapMarker.setLatLng([this.player.lat, this.player.lng]);
                }
            }

            updateActiveZombiesCount() {
                const activeCount = this.zombies.filter(z => z.active).length;
                document.getElementById('activeZombies').textContent = `${activeCount}/${this.zombies.length}`;
            }

            togglePause() {
                this.gamePaused = !this.gamePaused;
                document.getElementById('pauseBtn').textContent = this.gamePaused ? 'Reanudar' : 'Pausar';
                
                if (this.gamePaused) {
                    this.showNotification('Juego pausado');
                } else {
                    this.showNotification('Juego reanudado');
                }
            }

            gameOver() {
                this.gameActive = false;
                clearInterval(this.zombieSpawnInterval);
                clearInterval(this.supplySpawnInterval);
                clearTimeout(this.powerupTimer);
                
                if (this.watchId !== null) {
                    navigator.geolocation.clearWatch(this.watchId);
                }

                document.getElementById('finalScore').textContent = this.player.score;
                document.getElementById('finalSupplies').textContent = this.player.supplies;
                document.getElementById('finalLevel').textContent = this.gameLevel;
                
                document.getElementById('gameOverModal').classList.remove('hidden');
            }

            restartGame() {
                // Limpiar el mapa
                this.map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        this.map.removeLayer(layer);
                    }
                });

                // Limpiar arrays
                this.zombies = [];
                this.supplies = [];
                this.powerups = [];
                this.zombieGroups = [];

                // Limpiar intervalos
                clearInterval(this.zombieSpawnInterval);
                clearInterval(this.supplySpawnInterval);
                clearTimeout(this.powerupTimer);

                if (this.watchId !== null) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }

                // Reiniciar variables
                this.player = null;
                this.gameActive = false;
                this.mockMode = false;
                this.gamePaused = false;
                this.activePowerup = null;
                this.gameLevel = 1;

                // Actualizar HUD
                document.getElementById('score').textContent = '0';
                document.getElementById('supplies').textContent = '0';
                document.getElementById('level').textContent = '1';
                document.getElementById('healthBar').style.width = '100%';
                document.getElementById('healthText').textContent = '100%';
                document.getElementById('powerupInfo').textContent = 'No hay power-ups activos';
                document.getElementById('zombieCount').textContent = '0';

                // Ocultar modal de game over
                document.getElementById('gameOverModal').classList.add('hidden');

                // Mostrar modal de inicio
                document.getElementById('startModal').classList.remove('hidden');
            }

            showInstructions() {
                document.getElementById('startModal').classList.add('hidden');
                document.getElementById('instructionsModal').classList.remove('hidden');
            }

            hideInstructions() {
                document.getElementById('instructionsModal').classList.add('hidden');
                document.getElementById('startModal').classList.remove('hidden');
            }
        }

        // Inicializar el juego cuando se carga la pÃ¡gina
        let game;
        window.onload = () => {
            game = new Game();
        };
    </script>
</body>
</html>