<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exterminador de Ratas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #fff;
            overflow: hidden;
        }
        
        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        #header {
            background-color: #16213e;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }
        
        #game-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #e94560;
        }
        
        #stats {
            display: flex;
            gap: 20px;
        }
        
        .stat {
            background-color: #0f3460;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        #main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        #map-container {
            flex: 7;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        
        #tools-container {
            flex: 3;
            background-color: #16213e;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section-title {
            color: #e94560;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        #tools {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .tool {
            background-color: #0f3460;
            border: none;
            border-radius: 10px;
            padding: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .tool:hover {
            background-color: #133b74;
            transform: translateY(-2px);
        }
        
        .tool:active {
            transform: translateY(1px);
        }
        
        .tool-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .tool-count {
            background-color: #e94560;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        #rat-alert {
            background-color: rgba(233, 69, 96, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            display: none;
        }
        
        #messages {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #game-over h2 {
            font-size: 3rem;
            color: #e94560;
            margin-bottom: 20px;
        }
        
        #restart-btn {
            padding: 15px 30px;
            background-color: #0f3460;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #restart-btn:hover {
            background-color: #133b74;
        }
        
        .rat-marker {
            background-color: #4a2c2c;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid #000;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .male {
            border-color: #3498db;
        }
        
        .female {
            border-color: #e84393;
        }
        
        .tool-selected {
            box-shadow: 0 0 0 3px #e94560;
        }
        
        @media (max-width: 768px) {
            #main-content {
                flex-direction: column;
            }
            
            #map-container {
                flex: 6;
            }
            
            #tools-container {
                flex: 4;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <h1 id="game-title">üöÄ Exterminador de Ratas</h1>
            <div id="stats">
                <div class="stat">üí∞ Puntos: <span id="points">0</span></div>
                <div class="stat">üêÄ Ratas: <span id="rat-count">0</span></div>
                <div class="stat">üéØ Nivel: <span id="level">1</span></div>
            </div>
        </div>
        
        <div id="main-content">
            <div id="map-container">
                <div id="map"></div>
                <div id="game-over">
                    <h2>¬°Game Over!</h2>
                    <p>Las ratas han tomado el control de la ciudad.</p>
                    <button id="restart-btn">Reiniciar Juego</button>
                </div>
            </div>
            
            <div id="tools-container">
                <div>
                    <h3 class="section-title">üîß Herramientas</h3>
                    <div id="tools">
                        <button class="tool" data-tool="insecticide">
                            <div class="tool-icon">üí®</div>
                            <div>Insecticida</div>
                            <div class="tool-count">3</div>
                        </button>
                        <button class="tool" data-tool="poison">
                            <div class="tool-icon">‚ò†Ô∏è</div>
                            <div>Veneno</div>
                            <div class="tool-count">2</div>
                        </button>
                        <button class="tool" data-tool="trap">
                            <div class="tool-icon">üß©</div>
                            <div>Trampa</div>
                            <div class="tool-count">3</div>
                        </button>
                        <button class="tool" data-tool="block">
                            <div class="tool-icon">üöß</div>
                            <div>Bloquear</div>
                            <div class="tool-count">5</div>
                        </button>
                    </div>
                </div>
                
                <div id="rat-alert">
                    <strong>¬°Ratas cerca de tu ubicaci√≥n!</strong>
                    <p>Usa tus herramientas para eliminarlas.</p>
                </div>
                
                <div>
                    <h3 class="section-title">üìù Mensajes</h3>
                    <div id="messages">
                        <div class="message">¬°Bienvenido a Exterminador de Ratas! Tu misi√≥n es eliminar todas las ratas de la ciudad.</div>
                        <div class="message">Las ratas se reproducen r√°pidamente. ¬°No dejes que se multipliquen!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Variables globales del juego
        let map, userMarker, userLocation;
        let rats = [];
        let selectedTool = null;
        let points = 0;
        let ratCount = 0;
        let level = 1;
        let gameActive = true;
        
        // Configuraci√≥n del juego
        const GAME_CONFIG = {
            initialRats: 5,
            maxRats: 30,
            reproductionProbability: 0.03,
            movementInterval: 2000,
            ratSpawnInterval: 10000,
            pointsPerRat: 10,
            pointsPerLevel: 100
        };
        
        // Inicializaci√≥n del juego
        function initGame() {
            // Reiniciar variables
            points = 0;
            ratCount = 0;
            level = 1;
            rats = [];
            gameActive = true;
            
            // Actualizar UI
            document.getElementById('points').textContent = points;
            document.getElementById('rat-count').textContent = ratCount;
            document.getElementById('level').textContent = level;
            document.getElementById('game-over').style.display = 'none';
            
            // Obtener ubicaci√≥n del usuario
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        initMap();
                        spawnInitialRats();
                        startGameLoop();
                    },
                    error => {
                        // En caso de error, usar una ubicaci√≥n por defecto (Madrid)
                        userLocation = [40.4168, -3.7038];
                        initMap();
                        spawnInitialRats();
                        startGameLoop();
                        addMessage('No se pudo obtener tu ubicaci√≥n. Usando ubicaci√≥n predeterminada.');
                    }
                );
            } else {
                addMessage('Tu navegador no soporta geolocalizaci√≥n. Usando ubicaci√≥n predeterminada.');
                userLocation = [40.4168, -3.7038];
                initMap();
                spawnInitialRats();
                startGameLoop();
            }
            
            // Configurar event listeners para herramientas
            setupEventListeners();
        }
        
        // Inicializar el mapa
        function initMap() {
            map = L.map('map').setView(userLocation, 16);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Marcador del usuario
            userMarker = L.marker(userLocation)
                .addTo(map)
                .bindPopup('¬°Tu ubicaci√≥n!')
                .openPopup();
        }
        
        // Generar ratas iniciales
        function spawnInitialRats() {
            for (let i = 0; i < GAME_CONFIG.initialRats; i++) {
                spawnRat();
            }
        }
        
        // Generar una nueva rata
        function spawnRat() {
            if (ratCount >= GAME_CONFIG.maxRats || !gameActive) return;
            
            // Generar ubicaci√≥n aleatoria cerca del usuario
            const offset = 0.005;
            const lat = userLocation[0] + (Math.random() * offset * 2) - offset;
            const lng = userLocation[1] + (Math.random() * offset * 2) - offset;
            
            // Determinar sexo aleatoriamente
            const isMale = Math.random() > 0.5;
            const sex = isMale ? 'male' : 'female';
            
            // Crear marcador para la rata
            const ratMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: `rat-marker ${sex}`,
                    iconSize: [20, 20]
                })
            }).addTo(map);
            
            // A√±adir informaci√≥n de la rata
            const rat = {
                marker: ratMarker,
                sex: sex,
                age: 0,
                pregnant: false,
                birthCountdown: 0
            };
            
            rats.push(rat);
            ratCount++;
            
            // Actualizar contador de ratas
            document.getElementById('rat-count').textContent = ratCount;
            
            // Comprobar si hay demasiadas ratas (condici√≥n de derrota)
            if (ratCount >= GAME_CONFIG.maxRats) {
                endGame();
            }
            
            // A√±adir evento para eliminar rata al hacer clic (solo para debugging)
            ratMarker.on('click', () => {
                if (selectedTool === 'insecticide') {
                    removeRat(rat);
                    addPoints(GAME_CONFIG.pointsPerRat);
                    addMessage('¬°Has eliminado una rata con insecticida!');
                }
            });
            
            return rat;
        }
        
        // Eliminar una rata
        function removeRat(rat) {
            map.removeLayer(rat.marker);
            rats = rats.filter(r => r !== rat);
            ratCount--;
            document.getElementById('rat-count').textContent = ratCount;
        }
        
        // Bucle principal del juego
        function startGameLoop() {
            // Mover ratas peri√≥dicamente
            setInterval(moveRats, GAME_CONFIG.movementInterval);
            
            // Generar nuevas ratas peri√≥dicamente
            setInterval(() => {
                if (rats.length < GAME_CONFIG.maxRats && gameActive) {
                    spawnRat();
                }
            }, GAME_CONFIG.ratSpawnInterval);
        }
        
        // Mover las ratas
        function moveRats() {
            if (!gameActive) return;
            
            rats.forEach(rat => {
                // Mover la rata aleatoriamente
                const currentPos = rat.marker.getLatLng();
                const offset = 0.0005;
                const newLat = currentPos.lat + (Math.random() * offset * 2) - offset;
                const newLng = currentPos.lng + (Math.random() * offset * 2) - offset;
                
                rat.marker.setLatLng([newLat, newLng]);
                rat.age++;
                
                // Comprobar reproducci√≥n
                if (!rat.pregnant && rat.age > 5) {
                    checkReproduction(rat);
                }
                
                // Comprobar si la rata est√° pre√±ada
                if (rat.pregnant) {
                    rat.birthCountdown--;
                    
                    if (rat.birthCountdown <= 0) {
                        giveBirth(rat);
                    }
                }
            });
        }
        
        // Comprobar reproducci√≥n entre ratas
        function checkReproduction(rat) {
            // Solo las hembras pueden quedar pre√±adas
            if (rat.sex !== 'female') return;
            
            const currentPos = rat.marker.getLatLng();
            
            // Buscar machos cercanos
            const nearbyMales = rats.filter(otherRat => {
                if (otherRat.sex !== 'male' || otherRat === rat) return false;
                
                const otherPos = otherRat.marker.getLatLng();
                const distance = map.distance(currentPos, otherPos);
                
                return distance < 50; // 50 metros
            });
            
            if (nearbyMales.length > 0 && Math.random() < GAME_CONFIG.reproductionProbability) {
                rat.pregnant = true;
                rat.birthCountdown = 5;
                addMessage('¬°Una rata hembra ha quedado pre√±ada!');
            }
        }
        
        // Una rata da a luz
        function giveBirth(rat) {
            rat.pregnant = false;
            
            // Nacer entre 1 y 3 cr√≠as
            const offspringCount = Math.floor(Math.random() * 3) + 1;
            
            for (let i = 0; i < offspringCount; i++) {
                if (rats.length < GAME_CONFIG.maxRats) {
                    const currentPos = rat.marker.getLatLng();
                    const offset = 0.0001;
                    const newLat = currentPos.lat + (Math.random() * offset * 2) - offset;
                    const newLng = currentPos.lng + (Math.random() * offset * 2) - offset;
                    
                    // Determinar sexo aleatoriamente
                    const isMale = Math.random() > 0.5;
                    const sex = isMale ? 'male' : 'female';
                    
                    // Crear marcador para la cr√≠a
                    const offspringMarker = L.marker([newLat, newLng], {
                        icon: L.divIcon({
                            className: `rat-marker ${sex}`,
                            iconSize: [15, 15]
                        })
                    }).addTo(map);
                    
                    // A√±adir la nueva rata
                    rats.push({
                        marker: offspringMarker,
                        sex: sex,
                        age: 0,
                        pregnant: false,
                        birthCountdown: 0
                    });
                    
                    ratCount++;
                }
            }
            
            document.getElementById('rat-count').textContent = ratCount;
            addMessage(`¬°Una rata ha dado a luz a ${offspringCount} cr√≠as!`);
            
            // Comprobar si hay demasiadas ratas (condici√≥n de derrota)
            if (ratCount >= GAME_CONFIG.maxRats) {
                endGame();
            }
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Selecci√≥n de herramientas
            document.querySelectorAll('.tool').forEach(tool => {
                tool.addEventListener('click', () => {
                    document.querySelectorAll('.tool').forEach(t => t.classList.remove('tool-selected'));
                    tool.classList.add('tool-selected');
                    selectedTool = tool.dataset.tool;
                });
            });
            
            // Evento para colocar herramientas en el mapa
            map.on('click', e => {
                if (!selectedTool || !gameActive) return;
                
                const toolCountEl = document.querySelector(`.tool[data-tool="${selectedTool}"] .tool-count`);
                let count = parseInt(toolCountEl.textContent);
                
                if (count > 0) {
                    count--;
                    toolCountEl.textContent = count;
                    
                    switch(selectedTool) {
                        case 'insecticide':
                            useInsecticide(e.latlng);
                            break;
                        case 'poison':
                            usePoison(e.latlng);
                            break;
                        case 'trap':
                            useTrap(e.latlng);
                            break;
                        case 'block':
                            useBlock(e.latlng);
                            break;
                    }
                    
                    // Si se acaban las herramientas de este tipo, deseleccionar
                    if (count === 0) {
                        document.querySelectorAll('.tool').forEach(t => t.classList.remove('tool-selected'));
                        selectedTool = null;
                    }
                }
            });
            
            // Bot√≥n de reinicio
            document.getElementById('restart-btn').addEventListener('click', initGame);
        }
        
        // Usar insecticida
        function useInsecticide(latlng) {
            // Eliminar ratas en un radio
            let ratsKilled = 0;
            
            rats.forEach(rat => {
                const ratPos = rat.marker.getLatLng();
                const distance = map.distance(latlng, ratPos);
                
                if (distance < 30) { // 30 metros de radio
                    removeRat(rat);
                    ratsKilled++;
                }
            });
            
            if (ratsKilled > 0) {
                addPoints(ratsKilled * GAME_CONFIG.pointsPerRat);
                addMessage(`¬°Has eliminado ${ratsKilled} ratas con insecticida!`);
                
                // Marcar el √°rea de efecto temporalmente
                const area = L.circle(latlng, { radius: 30, color: '#e94560', fillOpacity: 0.2 }).addTo(map);
                setTimeout(() => map.removeLayer(area), 1000);
            }
        }
        
        // Usar veneno
        function usePoison(latlng) {
            // Envenenar ratas en un radio m√°s grande pero con efecto retardado
            let ratsPoisoned = 0;
            
            rats.forEach(rat => {
                const ratPos = rat.marker.getLatLng();
                const distance = map.distance(latlng, ratPos);
                
                if (distance < 50) { // 50 metros de radio
                    // La rata morir√° despu√©s de un tiempo
                    setTimeout(() => {
                        if (rats.includes(rat)) {
                            removeRat(rat);
                            addPoints(GAME_CONFIG.pointsPerRat);
                            addMessage('¬°Una rata ha muerto por envenenamiento!');
                        }
                    }, 5000);
                    
                    ratsPoisoned++;
                }
            });
            
            if (ratsPoisoned > 0) {
                addMessage(`¬°Has envenenado a ${ratsPoisoned} ratas! El efecto tardar√° unos segundos.`);
                
                // Marcar el √°rea de efecto temporalmente
                const area = L.circle(latlng, { radius: 50, color: '#9b59b6', fillOpacity: 0.2 }).addTo(map);
                setTimeout(() => map.removeLayer(area), 1000);
            }
        }
        
        // Usar trampa
        function useTrap(latlng) {
            // Colocar una trampa que atrapar√° ratas que pasen cerca
            const trap = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'trap-marker',
                    html: 'üß©',
                    iconSize: [25, 25]
                })
            }).addTo(map);
            
            // La trampa permanecer√° activa por un tiempo
            setTimeout(() => {
                map.removeLayer(trap);
            }, 15000);
            
            // Comprobar cada segundo si alguna rata pasa cerca
            const trapInterval = setInterval(() => {
                if (!map.hasLayer(trap)) {
                    clearInterval(trapInterval);
                    return;
                }
                
                rats.forEach(rat => {
                    const ratPos = rat.marker.getLatLng();
                    const distance = map.distance(latlng, ratPos);
                    
                    if (distance < 10) { // 10 metros de radio
                        removeRat(rat);
                        addPoints(GAME_CONFIG.pointsPerRat);
                        addMessage('¬°Una rata ha ca√≠do en tu trampa!');
                        map.removeLayer(trap);
                        clearInterval(trapInterval);
                    }
                });
            }, 1000);
            
            addMessage('¬°Has colocado una trampa! Atrapar√° ratas que pasen cerca.');
        }
        
        // Usar bloqueo de camino
        function useBlock(latlng) {
            // Bloquear el paso para las ratas
            const block = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'block-marker',
                    html: 'üöß',
                    iconSize: [25, 25]
                })
            }).addTo(map);
            
            // El bloqueo permanecer√° por un tiempo
            setTimeout(() => {
                map.removeLayer(block);
            }, 20000);
            
            addMessage('¬°Has bloqueado un camino! Las ratas evitar√°n esta zona.');
        }
        
        // A√±adir puntos
        function addPoints(amount) {
            points += amount;
            document.getElementById('points').textContent = points;
            
            // Comprobar si se sube de nivel
            if (points >= level * GAME_CONFIG.pointsPerLevel) {
                levelUp();
            }
        }
        
        // Subir de nivel
        function levelUp() {
            level++;
            document.getElementById('level').textContent = level;
            
            // A√±adir m√°s herramientas
            document.querySelectorAll('.tool').forEach(tool => {
                const toolType = tool.dataset.tool;
                const countEl = tool.querySelector('.tool-count');
                let count = parseInt(countEl.textContent);
                
                // A√±adir herramientas seg√∫n el tipo
                switch(toolType) {
                    case 'insecticide':
                        count += 2;
                        break;
                    case 'poison':
                        count += 1;
                        break;
                    case 'trap':
                        count += 1;
                        break;
                    case 'block':
                        count += 2;
                        break;
                }
                
                countEl.textContent = count;
            });
            
            addMessage(`¬°Has subido al nivel ${level}! Se han a√±adido m√°s herramientas.`);
        }
        
        // A√±adir mensaje al log
        function addMessage(text) {
            const messagesContainer = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = 'message';
            message.textContent = text;
            
            messagesContainer.appendChild(message);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Limitar el n√∫mero de mensajes
            if (messagesContainer.children.length > 20) {
                messagesContainer.removeChild(messagesContainer.children[0]);
            }
        }
        
        // Finalizar el juego
        function endGame() {
            gameActive = false;
            document.getElementById('game-over').style.display = 'flex';
            addMessage('¬°Game Over! Las ratas han tomado el control de la ciudad.');
        }
        
        // Iniciar el juego cuando se carga la p√°gina
        window.onload = initGame;
    </script>
</body>
</html>