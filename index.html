<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cazador de Monstruos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #ecf0f1;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            width: 100vw;
        }

        #header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        #game-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #game-title i {
            color: #e74c3c;
        }

        #stats {
            display: flex;
            gap: 15px;
        }

        .stat {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(5px);
        }

        #map-container {
            position: relative;
            height: 100%;
            width: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        #controls {
            display: flex;
            justify-content: center;
            padding: 12px;
            background-color: #2c3e50;
            gap: 10px;
            z-index: 10;
        }

        .control-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .monster-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px currentColor;
            transition: all 0.3s ease;
        }

        .goblin {
            background-color: #27ae60;
            border: 2px solid #2ecc71;
            color: #2ecc71;
        }

        .orc {
            background-color: #e74c3c;
            border: 2px solid #c0392b;
            color: #c0392b;
        }

        .troll {
            background-color: #8e44ad;
            border: 2px solid #9b59b6;
            color: #9b59b6;
        }

        .dragon {
            background-color: #f39c12;
            border: 2px solid #f1c40f;
            color: #f1c40f;
        }

        .user-marker {
            font-size: 24px;
            color: #3498db;
            text-align: center;
            line-height: 24px;
        }

        #monster-info {
            position: absolute;
            top: 70px;
            right: 10px;
            background: rgba(44, 62, 80, 0.9);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .monster-type {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }

        .monster-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes appear {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            #header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            #stats {
                width: 100%;
                justify-content: space-between;
            }
            
            .stat {
                font-size: 0.9rem;
                padding: 5px 10px;
            }
            
            .control-btn {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            
            #monster-info {
                top: 120px;
                right: 5px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header id="header">
            <h1 id="game-title"><i class="fas fa-dragon"></i> Cazador de Monstruos</h1>
            <div id="stats">
                <div class="stat"><i class="fas fa-skull"></i> Monstruos: <span id="monster-count">0</span></div>
                <div class="stat"><i class="fas fa-coins"></i> Puntos: <span id="points">0</span></div>
                <div class="stat"><i class="fas fa-crosshairs"></i> Eliminados: <span id="kills">0</span></div>
            </div>
        </header>
        
        <div id="map-container">
            <div id="map"></div>
            
            <div id="monster-info">
                <h3>Tipos de Monstruos</h3>
                <div class="monster-type">
                    <div class="monster-color" style="background-color: #27ae60; border: 2px solid #2ecc71;"></div>
                    <span>Goblin (+10 pts)</span>
                </div>
                <div class="monster-type">
                    <div class="monster-color" style="background-color: #e74c3c; border: 2px solid #c0392b;"></div>
                    <span>Orco (+15 pts)</span>
                </div>
                <div class="monster-type">
                    <div class="monster-color" style="background-color: #8e44ad; border: 2px solid #9b59b6;"></div>
                    <span>Troll (+20 pts)</span>
                </div>
                <div class="monster-type">
                    <div class="monster-color" style="background-color: #f39c12; border: 2px solid #f1c40f;"></div>
                    <span>Dragón (+30 pts)</span>
                </div>
            </div>
        </div>
        
        <div id="controls">
            <button class="control-btn" id="pause-btn"><i class="fas fa-pause"></i> Pausa</button>
            <button class="control-btn" id="add-monster-btn"><i class="fas fa-plus"></i> Añadir Monstruo</button>
            <button class="control-btn" id="clear-btn"><i class="fas fa-broom"></i> Limpiar</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales del juego
        let map, userMarker, userLocation;
        let monsters = [];
        let points = 0;
        let kills = 0;
        let gameActive = true;
        let paused = false;
        let lastSpawnTime = 0;
        let mapBounds = null;

        // Tipos de monstruos con características únicas
        const MONSTER_TYPES = [
            { 
                name: "goblin", 
                icon: "fas fa-ghost", 
                color: "goblin", 
                speed: 0.00015,
                points: 10,
                spawnChance: 0.4
            },
            { 
                name: "orc", 
                icon: "fas fa-hat-cowboy-side", 
                color: "orc", 
                speed: 0.00012,
                points: 15,
                spawnChance: 0.3
            },
            { 
                name: "troll", 
                icon: "fas fa-mountain", 
                color: "troll", 
                speed: 0.00008,
                points: 20,
                spawnChance: 0.2
            },
            { 
                name: "dragon", 
                icon: "fas fa-dragon", 
                color: "dragon", 
                speed: 0.00025,
                points: 30,
                spawnChance: 0.1
            }
        ];

        // Inicialización del juego
        function initGame() {
            // Reiniciar variables
            points = 0;
            kills = 0;
            monsters = [];
            gameActive = true;
            paused = false;
            lastSpawnTime = 0;

            // Actualizar UI
            updateUI();

            // Obtener ubicación del usuario
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        initMap();
                        startGameLoop();
                        // Generar monstruos iniciales
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => spawnMonster(), i * 500);
                        }
                    },
                    error => {
                        // En caso de error, usar una ubicación por defecto (Madrid)
                        userLocation = [40.4168, -3.7038];
                        initMap();
                        startGameLoop();
                        // Generar monstruos iniciales
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => spawnMonster(), i * 500);
                        }
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                userLocation = [40.4168, -3.7038];
                initMap();
                startGameLoop();
                // Generar monstruos iniciales
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => spawnMonster(), i * 500);
                }
            }

            // Configurar event listeners
            setupEventListeners();
        }

        // Inicializar el mapa
        function initMap() {
            // Limpiar mapa existente
            if (map) {
                map.remove();
            }

            // Crear el mapa
            map = L.map('map', {
                zoomControl: true,
                dragging: true,
                scrollWheelZoom: true
            }).setView(userLocation, 15);

            // Añadir capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Obtener los límites del mapa
            mapBounds = map.getBounds();
            
            // Marcador del usuario
            userMarker = L.marker(userLocation, {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: '<i class="fas fa-user"></i>',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('¡Tu ubicación!').openPopup();

            // Invalidar el tamaño del mapa para asegurar que se renderice correctamente
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        // Generar un nuevo monstruo en una ubicación aleatoria del mapa
        function spawnMonster() {
            if (!gameActive || paused || monsters.length >= 25) return;

            // Seleccionar un tipo de monstruo aleatorio basado en probabilidades
            const rand = Math.random();
            let cumulativeChance = 0;
            let monsterType;
            
            for (const type of MONSTER_TYPES) {
                cumulativeChance += type.spawnChance;
                if (rand <= cumulativeChance) {
                    monsterType = type;
                    break;
                }
            }
            
            // Generar ubicación aleatoria en todo el mapa, no solo cerca del jugador
            const bounds = map.getBounds();
            const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
            const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());

            // Crear marcador para el monstruo
            const monsterMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: `monster-marker ${monsterType.color}`,
                    html: `<i class="${monsterType.icon}"></i>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(map);

            // Añadir información del monstruo
            const monster = {
                marker: monsterMarker,
                type: monsterType.name,
                speed: monsterType.speed * (0.8 + Math.random() * 0.4),
                direction: Math.random() * Math.PI * 2,
                directionChangeTime: 0,
                points: monsterType.points,
                waypoints: [],
                currentWaypoint: 0,
                pauseTime: 0
            };

            // Generar waypoints para una ruta más interesante
            generateWaypoints(monster);

            monsters.push(monster);
            updateUI();

            // Añadir evento para eliminar monstruo al hacer clic
            monsterMarker.on('click', () => {
                removeMonster(monster, true);
            });

            // Animación de aparición
            monsterMarker.getElement().style.animation = 'appear 0.5s forwards';

            return monster;
        }

        // Generar waypoints para que el monstruo siga una ruta
        function generateWaypoints(monster) {
            const bounds = map.getBounds();
            const currentPos = monster.marker.getLatLng();
            
            // Limpiar waypoints anteriores
            monster.waypoints = [];
            monster.currentWaypoint = 0;
            
            // El primer waypoint es la posición actual
            monster.waypoints.push(currentPos);
            
            // Generar 3-5 waypoints adicionales en el mapa
            const numWaypoints = 3 + Math.floor(Math.random() * 3);
            for (let i = 0; i < numWaypoints; i++) {
                const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
                const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
                monster.waypoints.push(L.latLng(lat, lng));
            }
        }

        // Eliminar un monstruo
        function removeMonster(monster, addPoints = false) {
            if (!monster || !monster.marker) return;
            
            if (addPoints) {
                points += monster.points;
                kills++;
                
                // Efecto visual al eliminar
                const pos = monster.marker.getLatLng();
                const explosion = L.circleMarker(pos, {
                    radius: 15,
                    color: '#ff0000',
                    fillColor: '#ff8800',
                    fillOpacity: 0.7
                }).addTo(map);
                
                setTimeout(() => {
                    map.removeLayer(explosion);
                }, 500);
            }
            
            map.removeLayer(monster.marker);
            monsters = monsters.filter(m => m !== monster);
            updateUI();
        }

        // Mover los monstruos siguiendo sus waypoints
        function moveMonsters(deltaTime) {
            const now = Date.now();
            const moveFactor = deltaTime / 16;
            
            monsters.forEach(monster => {
                // Si el monstruo está en pausa (esperando en un waypoint)
                if (monster.pauseTime > now) {
                    return;
                }
                
                // Obtener el waypoint actual
                const currentWaypoint = monster.waypoints[monster.currentWaypoint];
                const currentPos = monster.marker.getLatLng();
                
                // Calcular la dirección hacia el waypoint
                const dx = currentWaypoint.lng - currentPos.lng;
                const dy = currentWaypoint.lat - currentPos.lat;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // Si está lo suficientemente cerca del waypoint, pasar al siguiente
                if (distance < 0.0005) {
                    monster.currentWaypoint = (monster.currentWaypoint + 1) % monster.waypoints.length;
                    
                    // Pausa aleatoria en el waypoint (0-3 segundos)
                    monster.pauseTime = now + Math.random() * 3000;
                    return;
                }
                
                // Calcular el movimiento hacia el waypoint
                const moveDistance = monster.speed * moveFactor;
                const ratio = moveDistance / distance;
                
                const newLat = currentPos.lat + dy * ratio;
                const newLng = currentPos.lng + dx * ratio;
                
                // Mantener a los monstruos dentro de los límites del mapa
                const bounds = map.getBounds();
                if (bounds.contains([newLat, newLng])) {
                    monster.marker.setLatLng([newLat, newLng]);
                } else {
                    // Si se sale del mapa, generar nuevos waypoints
                    generateWaypoints(monster);
                }
            });
        }

        // Bucle principal del juego
        function startGameLoop() {
            let lastUpdateTime = Date.now();
            
            const gameLoop = () => {
                if (!gameActive) return;
                
                const now = Date.now();
                const deltaTime = now - lastUpdateTime;
                lastUpdateTime = now;
                
                if (!paused) {
                    moveMonsters(deltaTime);
                    
                    // Generar nuevos monstruos cada 3 segundos
                    if (now - lastSpawnTime > 3000 && monsters.length < 25) {
                        spawnMonster();
                        lastSpawnTime = now;
                    }
                }
                
                requestAnimationFrame(gameLoop);
            };
            
            gameLoop();
        }

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('pause-btn').addEventListener('click', togglePause);
            document.getElementById('add-monster-btn').addEventListener('click', () => spawnMonster());
            document.getElementById('clear-btn').addEventListener('click', clearMonsters);
        }

        // Alternar pausa
        function togglePause() {
            paused = !paused;
            const pauseBtn = document.getElementById('pause-btn');
            
            if (paused) {
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> Reanudar';
            } else {
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pausa';
            }
        }

        // Limpiar monstruos
        function clearMonsters() {
            monsters.forEach(monster => {
                map.removeLayer(monster.marker);
            });
            monsters = [];
            updateUI();
        }

        // Actualizar la UI
        function updateUI() {
            document.getElementById('monster-count').textContent = monsters.length;
            document.getElementById('points').textContent = points;
            document.getElementById('kills').textContent = kills;
        }

        // Iniciar el juego cuando se carga la página
        window.onload = initGame;

        // Manejar redimensionamiento de ventana
        window.addEventListener('resize', () => {
            if (map) {
                map.invalidateSize();
                // Actualizar los límites del mapa después del redimensionamiento
                mapBounds = map.getBounds();
            }
        });
    </script>
</body>
</html>